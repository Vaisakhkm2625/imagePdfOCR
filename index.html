<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
        <link href="style.css" rel="stylesheet">


    </head>

    <body>

        <header>
            <h1 class="title">Img2Pdf</h1>
        </header>
        <main>
            <section class="container">
                <div id="controls">
                    <div id="drop_zone">
                        <div>
                            <snap class="drop_zone_text">Drag'nDrop Your Images Here</snap>
                        </div>
                        <input type="file" id="imageInput" multiple accept="image/*" style="display:none;">
                    </div>

                    <div id="controls_side">

                        <span id="discription"> Upload images and press convert button
                        it will combine images provides OCR enabled (selectedable text) pdf file </span>


                        <button id="convert" class="button"> Convert to PDF </button>
                        <span> status: <span id="statusDiv"> <span/>  </span>

                    </div>
                </div>
            </section>

            <section  class="container">
                <div id="preview_area">

                </div>

            </section>
        </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>

        <script>

    const { jsPDF } = window.jspdf;

        drop_zone.addEventListener("dragover",(e)=> {
            e.preventDefault();
            drop_zone.classList.add("dragover");
        })

        drop_zone.addEventListener("dragleave",(e)=> {
            e.preventDefault();
            drop_zone.classList.remove("dragover")
        })


        drop_zone.addEventListener("click",(e)=> {
            imageInput.click();
        })

        imageInput.addEventListener("change", (e)=>{
            handleFile(e.target.files);

        })

        drop_zone.addEventListener("drop",(e)=> {
            e.preventDefault();
            drop_zone.classList.remove("dragover")

            console.log(e.dataTransfer.files)
            handleFile(e.dataTransfer.files);
        })

        selectedFiles = []


        // function handleFile(files) {
        //     for (const file of files) {
        //         console.log(file)
        //
        //         if (file.type.startsWith("image/")) {
        //             selectedFiles.push(file);
        //
        //             const img = document.createElement("img");
        //             img.src = URL.createObjectURL(file);
        //             img.classList.add("preview-img");
        //             preview.appendChild(img);
        //         }
        //     }
        // }

    async function handleFile(files) {
      // const files = e.target.files;
      if (!files.length) return;
      statusDiv.innerHTML = 'Processing files...';
      const pdf = new jsPDF();
      let firstPage = true;
      const pxToMm = 0.2646; // conversion factor

      for (let file of files) {
        if (!file.type.startsWith('image/')) continue;
        console.log(file)


        statusDiv.innerHTML = 'Processing files...';
            console.log(statusDiv)
        const dataURL = await readFileAsDataURL(file);
        const img = await loadImage(dataURL);



        // Create preview container
        const preview = document.createElement('div');
        preview.className = 'preview-container';
        preview.style.width = img.width + 'px';
        preview.style.height = img.height + 'px';

        const previewImg = document.createElement('img');
        previewImg.src = dataURL;
        preview.appendChild(previewImg);
        preview_area.appendChild(preview);

        // Perform OCR and get detailed data including bounding boxes
        const result = await Tesseract.recognize(img, 'eng', {
                logger: (m) => {
                    console.log(m) ;
                    console.log(m.progress * 100) ;
                    statusDiv.innerHTML =  m.progress * 100; 
                }
        });

        // For PDF generation
        let imgWidth = img.width * pxToMm;
        let imgHeight = img.height * pxToMm;
        if (!firstPage) {
          pdf.addPage();
        } else {
          firstPage = false;
        }
        pdf.internal.pageSize.setWidth(imgWidth);
        pdf.internal.pageSize.setHeight(imgHeight);
        pdf.addImage(dataURL, 'JPEG', 0, 0, imgWidth, imgHeight);

        // Overlay OCR text using word bounding boxes for better alignment.
        result.data.words.forEach(word => {
          // Create animated box for preview
          const { x0, y0, x1, y1 } = word.bbox;
          const box = document.createElement('div');
          box.className = 'box';
          box.style.left = x0 + 'px';
          box.style.top = y0 + 'px';
          box.style.width = (x1 - x0) + 'px';
          box.style.height = (y1 - y0) + 'px';
          preview.appendChild(box);

          // Add OCR text to PDF using bounding box
          const x_mm = x0 * pxToMm;
          const y_mm = y0 * pxToMm;
          const boxHeight_mm = (y1 - y0) * pxToMm;
          pdf.setFontSize(boxHeight_mm);
          try {
            if (pdf.setGState && pdf.GState) {
              pdf.setGState(new pdf.GState({ opacity: 0 }));
            }
          } catch(e) { console.warn("GState not supported."); }
          pdf.text(word.text, x_mm, y_mm + boxHeight_mm, { baseline: 'bottom' });
          try {
            if (pdf.setGState && pdf.GState) {
              pdf.setGState(new pdf.GState({ opacity: 1 }));
            }
          } catch(e) {}
        });
      }
      statusDiv.innerHTML = 'Processing complete. Downloading PDF...';
      pdf.save('ocr_enabled.pdf');
      statusDiv.innerHTML = 'Download initiated.';
    }




    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    function loadImage(dataURL) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = err => reject(err);
        img.src = dataURL;
      });
    }














        </script>

    </body>
</html>
